@namespace PanoramicData.Blazor
@inherits PDComponentBase

@if (IsVisible)
{
	<div class="pd-dashboard @(CssClass) @Css" id="@Id">

		@if (ShowTabs && !DisplayMode && Tabs.Count > 1)
		{
			<ul class="nav nav-tabs pd-dashboard-tabs">
				@for (var i = 0; i < Tabs.Count; i++)
				{
					var index = i;
					var tab = Tabs[index];
					<li class="nav-item">
						<button class="nav-link @(index == _activeTabIndex ? "active" : "")"
								@onclick="() => SelectTabAsync(index)"
								@onclick:preventDefault>
							@tab.Name
						</button>
					</li>
				}
				@if (IsEditable)
				{
					<li class="nav-item">
						<button class="nav-link pd-dashboard-tab-add" @onclick="AddTabAsync" title="Add tab">
							<span class="fas fa-plus"></span>
						</button>
					</li>
				}
			</ul>
		}

		@if (Tabs.Count > 0 && _activeTabIndex >= 0 && _activeTabIndex < Tabs.Count)
		{
			var activeTab = Tabs[_activeTabIndex];
			var cols = activeTab.ColumnCount ?? ColumnCount;
			var rowHeight = activeTab.TileRowHeightPx ?? TileRowHeightPx;

			<div class="pd-dashboard-grid @(activeTab.Css)"
					 style="display: grid; grid-template-columns: repeat(@cols, 1fr); grid-auto-rows: @(rowHeight)px; gap: 0.5rem; padding: 0.5rem;">

					@foreach (var tile in activeTab.Tiles)
					{
						var gridStyle = $"grid-column: {tile.ColumnIndex + 1} / span {tile.ColumnSpanCount}; grid-row: {tile.RowIndex + 1} / span {tile.RowSpanCount};";
						var tileClasses = $"pd-dashboard-tile {tile.Css} {(IsEditable ? "pd-dashboard-tile-editable" : "")} {(_resizingTile == tile ? "pd-dashboard-tile-resizing" : "")} {(_draggedTile == tile ? "pd-dashboard-tile-dragging" : "")} {(_dragOverTile == tile && _draggedTile != tile ? "pd-dashboard-tile-dragover" : "")}";

						<div class="@tileClasses"
							 style="@gridStyle"
							 draggable="@(IsEditable && _resizingTile is null ? "true" : "false")"
							 @ondragstart="(e) => OnTileDragStart(e, tile)"
							 @ondragover="(e) => OnTileDragOver(e, tile)"
							 @ondragover:preventDefault="@IsEditable"
							 @ondragleave="OnTileDragLeave"
							 @ondrop="(e) => OnTileDropAsync(e, tile)"
							 @ondrop:preventDefault="@IsEditable"
							 @ondragend="OnTileDragEnd">
							@tile.ChildContent
							@if (IsEditable)
							{
								<div class="pd-dashboard-tile-toolbar">
									<button class="pd-dashboard-tile-btn" draggable="false" title="Maximize"
											@onclick="() => MaximizeTile(tile)" @onclick:stopPropagation>
										<span class="fas fa-expand"></span>
									</button>
								</div>
								<div class="pd-dashboard-tile-resize-handle"
									 @onpointerdown="(e) => OnResizePointerDown(e, tile)"
									 @onpointerdown:stopPropagation
									 @onpointerdown:preventDefault>
								</div>
							}
						</div>
					}
				</div>

				@* Full-screen overlay to capture pointer events during resize *@
				@if (_resizingTile is not null)
				{
					<div class="pd-dashboard-resize-overlay"
						 @onpointermove="OnResizePointerMove"
						 @onpointermove:preventDefault
						 @onpointerup="OnResizePointerUp"
						 @onpointerup:preventDefault>
					</div>
				}

			@if (_maximizedTile is not null)
			{
				<div class="pd-dashboard-maximize-backdrop" @onclick="RestoreTile">
					<div class="pd-dashboard-maximize-content"
						 style="width: @(MaximizePercent)%; height: @(MaximizePercent)%;"
						 @onclick:stopPropagation>
						<button class="pd-dashboard-maximize-close" @onclick="RestoreTile" title="Restore">
							<span class="fas fa-compress"></span>
						</button>
						@_maximizedTile.ChildContent
					</div>
				</div>
			}
		}
	</div>
}
