@namespace PanoramicData.Blazor
@inherits PDComponentBase

@if (IsVisible)
{
	<div class="pd-dashboard @(CssClass) @Css" id="@Id" tabindex="0" @onkeydown="OnDashboardKeyDown">

		@if (DisplayMode && DisplayModeHeader != DisplayModeHeaderContent.None)
		{
			<div class="pd-dashboard-display-header">
				@if (IsRotationEnabled && Tabs.Count > 1)
				{
					<button class="pd-dashboard-display-nav" @onclick="NavigatePreviousTabAsync" title="Previous tab">
						<span class="fas fa-chevron-left"></span>
					</button>
				}
				<div class="pd-dashboard-display-title">
					@if ((DisplayModeHeader == DisplayModeHeaderContent.DashboardName || DisplayModeHeader == DisplayModeHeaderContent.Both) && !string.IsNullOrWhiteSpace(Name))
					{
						<span class="pd-dashboard-display-name">@Name</span>
					}
					@if (DisplayModeHeader == DisplayModeHeaderContent.Both && !string.IsNullOrWhiteSpace(Name) && ActiveTabIndex >= 0 && ActiveTabIndex < Tabs.Count)
					{
						<span class="pd-dashboard-display-separator"> — </span>
					}
					@if ((DisplayModeHeader == DisplayModeHeaderContent.TabName || DisplayModeHeader == DisplayModeHeaderContent.Both) && ActiveTabIndex >= 0 && ActiveTabIndex < Tabs.Count)
					{
						<span class="pd-dashboard-display-tabname">@Tabs[ActiveTabIndex].Name</span>
					}
				</div>
				@if (IsRotationEnabled && Tabs.Count > 1)
				{
					<div class="pd-dashboard-display-controls">
						<button class="pd-dashboard-display-nav" @onclick="ToggleRotationPauseAsync" title="@(_isRotationPaused ? "Resume rotation" : "Pause rotation")">
							<span class="fas @(_isRotationPaused ? "fa-play" : "fa-pause")"></span>
						</button>
						<button class="pd-dashboard-display-nav" @onclick="NavigateNextTabAsync" title="Next tab">
							<span class="fas fa-chevron-right"></span>
						</button>
					</div>
				}
			</div>
		}
		else if (!DisplayMode && ShowName && !string.IsNullOrWhiteSpace(Name))
		{
			<div class="pd-dashboard-name-row">
				<span class="pd-dashboard-name-text">@Name</span>
			</div>
		}

		@if (!DisplayMode && ((ShowTabs && Tabs.Count > 1) || EffectiveIsEditable || ShowEditButton || AllowViewModePropertyEdit))
		{
			<ul class="nav nav-tabs pd-dashboard-tabs">
				@if (ShowTabs && Tabs.Count > 1)
				{
					@for (var i = 0; i < Tabs.Count; i++)
					{
						var index = i;
						var tab = Tabs[index];
						<li class="nav-item">
							<button class="nav-link @(index == ActiveTabIndex ? "active" : "")"
									@onclick="() => SelectTabAsync(index)"
									@onclick:preventDefault>
								@tab.Name
							</button>
						</li>
					}
				}
				@if (EffectiveIsEditable)
				{
					<li class="nav-item">
						<button class="nav-link pd-dashboard-tab-add" @onclick="AddTabAsync" title="Add tab">
							<span class="fas fa-plus"></span>
						</button>
					</li>
					<li class="nav-item ms-auto">
						<button class="nav-link pd-dashboard-settings-btn" @onclick="OpenDashboardConfig" title="Dashboard settings">
							<span class="fas fa-cog"></span>
						</button>
					</li>
				}
				@if (AllowViewModePropertyEdit && !EffectiveIsEditable)
				{
					<li class="nav-item ms-auto">
						<button class="nav-link pd-dashboard-props-btn @(_isEditingViewModeProperties ? "active" : "")"
								@onclick="OpenViewModePropertyEdit"
								title="Override properties">
							<span class="fas fa-sliders-h"></span>
						</button>
					</li>
				}
				@if (ShowEditButton && !IsEditable)
				{
					<li class="nav-item @(!EffectiveIsEditable && !AllowViewModePropertyEdit ? "ms-auto" : "")">
						<button class="nav-link pd-dashboard-edit-btn @(EffectiveIsEditable ? "active" : "")"
								@onclick="ToggleEditModeAsync"
								title="@(EffectiveIsEditable ? "Done editing" : "Edit dashboard")">
							<span class="fas @(EffectiveIsEditable ? "fa-check" : "fa-edit")"></span>
						</button>
					</li>
				}
			</ul>
		}

		@if (Tabs.Count > 0 && ActiveTabIndex >= 0 && ActiveTabIndex < Tabs.Count)
		{
			var activeTab = Tabs[ActiveTabIndex];
			var cols = activeTab.ColumnCount ?? ColumnCount;
			var rowHeight = activeTab.TileRowHeightPx ?? TileRowHeightPx;

				<CascadingValue Value="EffectiveIsEditable" Name="DashboardIsEditable">
				<CascadingValue Value="WidgetHeaderCss" Name="DashboardWidgetHeaderCss">
				<CascadingValue Value="WidgetBorderCss" Name="DashboardWidgetBorderCss">
				<CascadingValue Value="WidgetContentCss" Name="DashboardWidgetContentCss">
				<CascadingValue Value="EffectiveProperties" Name="DashboardProperties">
				<div class="pd-dashboard-grid @(activeTab.Css)"
					 style="display: grid; grid-template-columns: repeat(@cols, 1fr); grid-auto-rows: @(rowHeight)px; gap: 0.5rem; padding: 0.5rem;"
					 @ondragover:preventDefault="@(EffectiveIsEditable && _draggedTile is not null)"
					 @ondrop="OnGridDropAsync"
					 @ondrop:preventDefault="@(EffectiveIsEditable && _draggedTile is not null)">

					@foreach (var tile in activeTab.Tiles)
						{
							var isMaximized = _maximizedTile == tile;
								var gridStyle = isMaximized
									? $"width: {MaximizePercent}%; height: {MaximizePercent}%;"
									: $"grid-column: {tile.ColumnIndex + 1} / span {tile.ColumnSpanCount}; grid-row: {tile.RowIndex + 1} / span {tile.RowSpanCount}; display: grid;";
							var tileClasses = $"pd-dashboard-tile {tile.Css} {(EffectiveIsEditable ? "pd-dashboard-tile-editable" : "")} {(_resizingTile == tile ? "pd-dashboard-tile-resizing" : "")} {(_draggedTile == tile ? "pd-dashboard-tile-dragging" : "")} {(_dragOverTile == tile && _draggedTile != tile ? "pd-dashboard-tile-dragover" : "")} {(isMaximized ? "pd-dashboard-tile-maximized" : "")}";
							var resizeInfo = _resizingTile == tile ? $"{tile.ColumnSpanCount} × {tile.RowSpanCount}" : null;

							<div class="@tileClasses"
								 style="@gridStyle"
								 data-resize-info="@resizeInfo"
								 draggable="@(EffectiveIsEditable && _resizingTile is null && !isMaximized ? "true" : "false")"
								 @ondragstart="(e) => OnTileDragStart(e, tile)"
								 @ondragover="(e) => OnTileDragOver(e, tile)"
								 @ondragover:preventDefault="@EffectiveIsEditable"
								 @ondragleave="OnTileDragLeave"
								 @ondrop="(e) => OnTileDropAsync(e, tile)"
								 @ondrop:preventDefault="@EffectiveIsEditable"
								 @ondragend="OnTileDragEnd">
										@tile.ChildContent
											@if (isMaximized)
											{
												<button class="pd-dashboard-maximize-close" @onclick="RestoreTile" @onclick:stopPropagation title="Restore">
													<span class="fas fa-compress"></span>
												</button>
											}
											@{
												var canMaximize = tile.ShowMaximize ?? ShowMaximize;
											}
											@if (!isMaximized && (EffectiveIsEditable || canMaximize))
										{
											<div class="pd-dashboard-tile-toolbar">
												@if (EffectiveIsEditable)
												{
													<button class="pd-dashboard-tile-btn pd-dashboard-tile-btn-danger" draggable="false" title="Delete"
															@onclick="() => RequestDeleteTileAsync(tile)" @onclick:stopPropagation>
														<span class="fas fa-trash-alt"></span>
													</button>
												}
												<button class="pd-dashboard-tile-btn" draggable="false" title="Maximize"
														@onclick="() => MaximizeTile(tile)" @onclick:stopPropagation>
													<span class="fas fa-expand"></span>
												</button>
											</div>
											@if (EffectiveIsEditable)
											{
												<div class="pd-dashboard-tile-resize-handle"
													 @onpointerdown="(e) => OnResizePointerDown(e, tile)"
													 @onpointerdown:stopPropagation
													 @onpointerdown:preventDefault>
												</div>
											}
										}
								</div>
							}

							@if (EffectiveIsEditable)
									{
										var addPosition = FindNextAvailablePosition();
										<div class="pd-dashboard-tile-add"
											 style="grid-column: @(addPosition.ColumnIndex + 1) / span 1; grid-row: @(addPosition.RowIndex + 1) / span 1;"
											 @onclick="RequestAddTileAsync">
											<span class="fas fa-plus fa-lg"></span>
											<span class="pd-dashboard-tile-add-label">Add Widget</span>
										</div>
									}
				</div>

				@* Full-screen overlay to capture pointer events during resize *@
				@if (_resizingTile is not null)
				{
					<div class="pd-dashboard-resize-overlay"
						 @onpointermove="OnResizePointerMove"
						 @onpointermove:preventDefault
						 @onpointerup="OnResizePointerUp"
						 @onpointerup:preventDefault>
					</div>
				}

			@if (_maximizedTile is not null)
			{
				<div class="pd-dashboard-maximize-backdrop" @onclick="RestoreTile"></div>
			}
							</CascadingValue>
							</CascadingValue>
							</CascadingValue>
							</CascadingValue>
							</CascadingValue>
						}

		@if (_isConfiguringDashboard && ActiveTabIndex >= 0 && ActiveTabIndex < Tabs.Count)
		{
			<div class="pd-dashboard-config-backdrop" @onclick="CancelDashboardConfig">
				<div class="pd-dashboard-config-dialog" @onclick:stopPropagation>
					<div class="pd-dashboard-config-header">
						<h6 class="mb-0">Dashboard Settings</h6>
						<button class="pd-dashboard-config-close" @onclick="CancelDashboardConfig" title="Close">
							<span class="fas fa-times"></span>
						</button>
					</div>
					<div class="pd-dashboard-config-body">
						<div class="pd-dashboard-config-field">
							<label>Dashboard Name</label>
							<input type="text" class="form-control form-control-sm" @bind="_configName" />
						</div>
						<div class="pd-dashboard-config-field">
							<label>Tab Name</label>
							<input type="text" class="form-control form-control-sm" @bind="_configTabName" />
						</div>
						<div class="pd-dashboard-config-field">
							<label>Columns</label>
							<input type="number" class="form-control form-control-sm" @bind="_configColumnCount" min="1" max="24" />
						</div>
						<div class="pd-dashboard-config-field">
							<label>Row Height (px)</label>
							<input type="number" class="form-control form-control-sm" @bind="_configRowHeight" min="40" max="500" />
						</div>
						<div class="pd-dashboard-config-separator"><span>Properties</span></div>
						@foreach (var kvp in _configProperties.ToList())
						{
							var propKey = kvp.Key;
							<div class="pd-dashboard-config-property-row">
								<input type="text" class="form-control form-control-sm" value="@propKey" readonly title="@propKey" />
								<input type="text" class="form-control form-control-sm"
									   value="@kvp.Value"
									   @oninput="(e) => UpdateConfigProperty(propKey, e.Value?.ToString() ?? string.Empty)" />
								<button class="pd-dashboard-tile-btn pd-dashboard-tile-btn-danger"
										@onclick="() => RemoveConfigProperty(propKey)" type="button" title="Remove property">
									<span class="fas fa-times"></span>
								</button>
							</div>
						}
						<div class="pd-dashboard-config-property-row">
							<input type="text" class="form-control form-control-sm" placeholder="Key" @bind="_newPropertyKey" />
							<input type="text" class="form-control form-control-sm" placeholder="Value" @bind="_newPropertyValue" />
							<button class="pd-dashboard-tile-btn" @onclick="AddConfigProperty" type="button" title="Add property">
								<span class="fas fa-plus"></span>
							</button>
						</div>
					</div>
					<div class="pd-dashboard-config-footer">
						<button class="btn btn-sm btn-outline-secondary" @onclick="CancelDashboardConfig">Cancel</button>
						<button class="btn btn-sm btn-primary" @onclick="ApplyDashboardConfigAsync">Apply</button>
					</div>
				</div>
			</div>
		}

		@if (_isEditingViewModeProperties)
		{
			<div class="pd-dashboard-config-backdrop" @onclick="CloseViewModePropertyEdit">
				<div class="pd-dashboard-config-dialog" @onclick:stopPropagation>
					<div class="pd-dashboard-config-header">
						<h6 class="mb-0">View Property Overrides</h6>
						<button class="pd-dashboard-config-close" @onclick="CloseViewModePropertyEdit" title="Close">
							<span class="fas fa-times"></span>
						</button>
					</div>
					<div class="pd-dashboard-config-body">
						@if (Properties is null || Properties.Count == 0)
						{
							<p class="text-muted small mb-0">No dashboard properties are defined.</p>
						}
						else
						{
							@foreach (var kvp in Properties)
							{
								var key = kvp.Key;
								var overrideValue = _viewModePropertyOverrides.TryGetValue(key, out var ov) ? ov : kvp.Value;
								<div class="pd-dashboard-config-field">
									<label>@key</label>
									<input type="text" class="form-control form-control-sm"
										   value="@overrideValue"
										   @oninput="(e) => SetViewModePropertyOverride(key, e.Value?.ToString() ?? string.Empty)" />
								</div>
							}
						}
					</div>
					<div class="pd-dashboard-config-footer">
						<button class="btn btn-sm btn-outline-secondary" @onclick="ResetViewModeProperties">Reset to Defaults</button>
						<button class="btn btn-sm btn-primary" @onclick="CloseViewModePropertyEdit">Done</button>
					</div>
				</div>
			</div>
		}

		@if (EffectiveIsEditable && ConfirmTileDelete)
		{
			<PDConfirm @ref="_confirmDelete"
					   Title="Delete Widget"
					   Message="Are you sure you want to delete this widget?" />
		}
	</div>
}
