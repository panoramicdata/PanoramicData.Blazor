@namespace PanoramicData.Blazor
@inherits PDComponentBase

@if (IsVisible)
{
	<div class="pd-dashboard @(CssClass) @Css" id="@Id" tabindex="0" @onkeydown="OnDashboardKeyDown">

		@if (!DisplayMode && ((ShowTabs && Tabs.Count > 1) || IsEditable))
		{
			<ul class="nav nav-tabs pd-dashboard-tabs">
				@if (ShowTabs && Tabs.Count > 1)
				{
					@for (var i = 0; i < Tabs.Count; i++)
					{
						var index = i;
						var tab = Tabs[index];
						<li class="nav-item">
							<button class="nav-link @(index == ActiveTabIndex ? "active" : "")"
									@onclick="() => SelectTabAsync(index)"
									@onclick:preventDefault>
								@tab.Name
							</button>
						</li>
					}
				}
				@if (IsEditable)
				{
					<li class="nav-item">
						<button class="nav-link pd-dashboard-tab-add" @onclick="AddTabAsync" title="Add tab">
							<span class="fas fa-plus"></span>
						</button>
					</li>
					<li class="nav-item ms-auto">
						<button class="nav-link pd-dashboard-settings-btn" @onclick="OpenDashboardConfig" title="Dashboard settings">
							<span class="fas fa-cog"></span>
						</button>
					</li>
				}
			</ul>
		}

		@if (Tabs.Count > 0 && ActiveTabIndex >= 0 && ActiveTabIndex < Tabs.Count)
		{
			var activeTab = Tabs[ActiveTabIndex];
			var cols = activeTab.ColumnCount ?? ColumnCount;
			var rowHeight = activeTab.TileRowHeightPx ?? TileRowHeightPx;

				<CascadingValue Value="IsEditable" Name="DashboardIsEditable">
				<CascadingValue Value="WidgetHeaderCss" Name="DashboardWidgetHeaderCss">
				<CascadingValue Value="WidgetBorderCss" Name="DashboardWidgetBorderCss">
				<CascadingValue Value="WidgetContentCss" Name="DashboardWidgetContentCss">
				<CascadingValue Value="Properties" Name="DashboardProperties">
				<div class="pd-dashboard-grid @(activeTab.Css)"
					 style="display: grid; grid-template-columns: repeat(@cols, 1fr); grid-auto-rows: @(rowHeight)px; gap: 0.5rem; padding: 0.5rem;"
					 @ondragover:preventDefault="@(IsEditable && _draggedTile is not null)"
					 @ondrop="OnGridDropAsync"
					 @ondrop:preventDefault="@(IsEditable && _draggedTile is not null)">

					@foreach (var tile in activeTab.Tiles)
						{
							var isMaximized = _maximizedTile == tile;
								var gridStyle = isMaximized
									? $"width: {MaximizePercent}%; height: {MaximizePercent}%;"
									: $"grid-column: {tile.ColumnIndex + 1} / span {tile.ColumnSpanCount}; grid-row: {tile.RowIndex + 1} / span {tile.RowSpanCount}; display: grid;";
							var tileClasses = $"pd-dashboard-tile {tile.Css} {(IsEditable ? "pd-dashboard-tile-editable" : "")} {(_resizingTile == tile ? "pd-dashboard-tile-resizing" : "")} {(_draggedTile == tile ? "pd-dashboard-tile-dragging" : "")} {(_dragOverTile == tile && _draggedTile != tile ? "pd-dashboard-tile-dragover" : "")} {(isMaximized ? "pd-dashboard-tile-maximized" : "")}";
							var resizeInfo = _resizingTile == tile ? $"{tile.ColumnSpanCount} Ã— {tile.RowSpanCount}" : null;

							<div class="@tileClasses"
								 style="@gridStyle"
								 data-resize-info="@resizeInfo"
								 draggable="@(IsEditable && _resizingTile is null && !isMaximized ? "true" : "false")"
								 @ondragstart="(e) => OnTileDragStart(e, tile)"
								 @ondragover="(e) => OnTileDragOver(e, tile)"
								 @ondragover:preventDefault="@IsEditable"
								 @ondragleave="OnTileDragLeave"
								 @ondrop="(e) => OnTileDropAsync(e, tile)"
								 @ondrop:preventDefault="@IsEditable"
								 @ondragend="OnTileDragEnd">
										@tile.ChildContent
											@if (isMaximized)
											{
												<button class="pd-dashboard-maximize-close" @onclick="RestoreTile" @onclick:stopPropagation title="Restore">
													<span class="fas fa-compress"></span>
												</button>
											}
											@{
												var canMaximize = tile.ShowMaximize ?? ShowMaximize;
											}
											@if (!isMaximized && (IsEditable || canMaximize))
										{
											<div class="pd-dashboard-tile-toolbar">
												@if (IsEditable)
												{
													<button class="pd-dashboard-tile-btn pd-dashboard-tile-btn-danger" draggable="false" title="Delete"
															@onclick="() => RequestDeleteTileAsync(tile)" @onclick:stopPropagation>
														<span class="fas fa-trash-alt"></span>
													</button>
												}
												<button class="pd-dashboard-tile-btn" draggable="false" title="Maximize"
														@onclick="() => MaximizeTile(tile)" @onclick:stopPropagation>
													<span class="fas fa-expand"></span>
												</button>
											</div>
											@if (IsEditable)
											{
												<div class="pd-dashboard-tile-resize-handle"
													 @onpointerdown="(e) => OnResizePointerDown(e, tile)"
													 @onpointerdown:stopPropagation
													 @onpointerdown:preventDefault>
												</div>
											}
										}
								</div>
							}

							@if (IsEditable && OnTileAdd.HasDelegate)
									{
										var addPosition = FindNextAvailablePosition();
										<div class="pd-dashboard-tile-add"
											 style="grid-column: @(addPosition.ColumnIndex + 1) / span 1; grid-row: @(addPosition.RowIndex + 1) / span 1;"
											 @onclick="RequestAddTileAsync">
											<span class="fas fa-plus fa-lg"></span>
											<span class="pd-dashboard-tile-add-label">Add Widget</span>
										</div>
									}
				</div>

				@* Full-screen overlay to capture pointer events during resize *@
				@if (_resizingTile is not null)
				{
					<div class="pd-dashboard-resize-overlay"
						 @onpointermove="OnResizePointerMove"
						 @onpointermove:preventDefault
						 @onpointerup="OnResizePointerUp"
						 @onpointerup:preventDefault>
					</div>
				}

			@if (_maximizedTile is not null)
			{
				<div class="pd-dashboard-maximize-backdrop" @onclick="RestoreTile"></div>
			}
							</CascadingValue>
							</CascadingValue>
							</CascadingValue>
							</CascadingValue>
							</CascadingValue>
						}

		@if (_isConfiguringDashboard && ActiveTabIndex >= 0 && ActiveTabIndex < Tabs.Count)
		{
			<div class="pd-dashboard-config-backdrop" @onclick="CancelDashboardConfig">
				<div class="pd-dashboard-config-dialog" @onclick:stopPropagation>
					<div class="pd-dashboard-config-header">
						<h6 class="mb-0">Dashboard Settings</h6>
						<button class="pd-dashboard-config-close" @onclick="CancelDashboardConfig" title="Close">
							<span class="fas fa-times"></span>
						</button>
					</div>
					<div class="pd-dashboard-config-body">
						<div class="pd-dashboard-config-field">
							<label>Tab Name</label>
							<input type="text" class="form-control form-control-sm" @bind="_configTabName" />
						</div>
						<div class="pd-dashboard-config-field">
							<label>Columns</label>
							<input type="number" class="form-control form-control-sm" @bind="_configColumnCount" min="1" max="24" />
						</div>
						<div class="pd-dashboard-config-field">
							<label>Row Height (px)</label>
							<input type="number" class="form-control form-control-sm" @bind="_configRowHeight" min="40" max="500" />
						</div>
					</div>
					<div class="pd-dashboard-config-footer">
						<button class="btn btn-sm btn-outline-secondary" @onclick="CancelDashboardConfig">Cancel</button>
						<button class="btn btn-sm btn-primary" @onclick="ApplyDashboardConfigAsync">Apply</button>
					</div>
				</div>
			</div>
		}

		@if (IsEditable && ConfirmTileDelete)
		{
			<PDConfirm @ref="_confirmDelete"
					   Title="Delete Widget"
					   Message="Are you sure you want to delete this widget?" />
		}
	</div>
}
